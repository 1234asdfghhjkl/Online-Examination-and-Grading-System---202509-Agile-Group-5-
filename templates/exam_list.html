<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>All Exams - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-4">
    <div class="container">
        <span class="navbar-brand fw-bold">ðŸ“š Online Exam System</span>
        <div class="d-flex">
            <a href="/profile?user_id={{lecturer_id}} " class="btn btn-outline-light btn-sm btn-rounded me-2">
                My Profile
            </a>
            
            <a href="/create-exam?lecturer_id={{lecturer_id}}" class="btn btn-light btn-sm btn-rounded fw-bold me-2">
                + Create New Exam
            </a>
            
            <a href="/login" class="btn btn-danger btn-sm btn-rounded">Logout</a>
        </div>
    </div>
</nav>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <div class="list-header mb-3">
        <h4 class="mb-1 fw-bold">All Exams</h4>
        <p class="text-muted mb-0">Manage your exams, questions, and publishing</p>
      </div>

      <form class="row g-2 mb-3" id="examFilterForm" onsubmit="return false;">
        <div class="col-md-6">
          <input
            type="text"
            class="form-control"
            id="examSearch"
            placeholder="Search by exam title..."
            value="{{search}}"
          />
        </div>
        <div class="col-md-4">
          <select class="form-select" id="sortSelect">
            <option value="date">Sort by date</option>
            <option value="title">Sort by title</option>
          </select>
        </div>
      </form>
      <div id="examListContainer">
        {{exam_list_html}}
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="deleteExamModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Exam</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete exam
          "<span class="fw-semibold" id="deleteExamTitle"></span>"?
        </p>
        <p class="text-muted mb-0">
          Choose how you want to delete:
        </p>
        <ul class="mt-2 mb-0 small text-muted">
          <li><strong>Soft delete</strong>: remove exam from list, records are kept.</li>
          <li><strong>Hard delete</strong>: permanently remove exam, questions, and submissions.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="confirmDelete('soft')">Soft Delete</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete('hard')">Delete Permanently</button>
      </div>
    </div>
  </div>
</div>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <div id="deleteToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header bg-success text-white">
      <strong class="me-auto">Success</strong>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="deleteToastBody">
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let currentExamId = null;

  const deleteModal = document.getElementById('deleteExamModal');
  if (deleteModal) {
    deleteModal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      currentExamId = button.getAttribute('data-exam-id');
      const title = button.getAttribute('data-exam-title') || '';
      document.getElementById('deleteExamTitle').textContent = title;
    });
  }

  function confirmDelete(method) {
    if (!currentExamId) return;
    const url = '/exam-delete?exam_id=' +
        encodeURIComponent(currentExamId) +
        '&method=' + encodeURIComponent(method);
    window.location.href = url;
  }

  (function () {
    var successMessage = "{{success_message}}";

    if (!successMessage || successMessage.trim() === "") {
      return;
    }

    var toastEl = document.getElementById('deleteToast');
    var bodyEl = document.getElementById('deleteToastBody');
    if (!toastEl || !bodyEl) return;

    bodyEl.textContent = successMessage;

    if (window.bootstrap && bootstrap.Toast) {
      var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toast.show();
    }
  })();

 // Live search + sort
  (function () {
    const searchInput = document.getElementById('examSearch');
    const sortSelect = document.getElementById('sortSelect');
    const container = document.getElementById('examListContainer');
    if (!searchInput || !sortSelect || !container) return;

    const cards = Array.from(container.querySelectorAll('.exam-card'));

    // Set initial sort from server value if you still pass it
    (function setInitialSort() {
      var currentSort = "{{sort}}";
      if (!currentSort) return;
      for (var i = 0; i < sortSelect.options.length; i++) {
        if (sortSelect.options[i].value === currentSort) {
          sortSelect.selectedIndex = i;
          break;
        }
      }
    })();

    function applyFilterSort() {
  const term = (searchInput.value || '').toLowerCase().trim();
  const sortBy = sortSelect.value || 'date';

  // Filter by title: keep cards that contain the term anywhere
  cards.forEach(card => {
    const title = (card.dataset.title || '').toLowerCase();
    const matches = !term || title.includes(term);
    card.style.display = matches ? '' : 'none';
  });

  // Sort only visible cards
  const visible = cards.filter(c => c.style.display !== 'none');

  visible.sort((a, b) => {
    const at = (a.dataset.title || '').toLowerCase();
    const bt = (b.dataset.title || '').toLowerCase();

    // When there is a search term, prioritise titles that START with it
    if (term) {
      const aStarts = at.startsWith(term);
      const bStarts = bt.startsWith(term);
      if (aStarts && !bStarts) return -1;
      if (!aStarts && bStarts) return 1;
    }

    if (sortBy === 'title') {
      // A â†’ Z
      return (a.dataset.title || '').localeCompare(b.dataset.title || '');
    } else {
      // date, newest first
      return (b.dataset.date || '').localeCompare(a.dataset.date || '');
    }
  });

  visible.forEach(card => container.appendChild(card));
}

    searchInput.addEventListener('input', applyFilterSort);
    sortSelect.addEventListener('change', applyFilterSort);

    applyFilterSort();
  })();
</script>

</body>
</html>