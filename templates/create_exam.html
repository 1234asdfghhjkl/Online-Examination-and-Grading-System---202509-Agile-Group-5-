<div class="card card-main">
    <div class="card-header">
        <h3 class="mb-1">Create New Exam</h3>
        <p class="mb-0">Step 1 of 3 Â· Define the basic exam details.</p>
    </div>
    <div class="card-body p-4">

        <div class="stepper">
            <div class="stepper-item">
                <div class="step-circle current">1</div>
                <span class="step-label">Exam Details</span>
                <div class="step-caption">You are here</div>
            </div>
            <div class="stepper-item">
                <div class="step-circle next">2</div>
                <span class="step-label">Add Questions</span>
                <div class="step-caption">MCQ / Short Answer</div>
            </div>
            <div class="stepper-item">
                <div class="step-circle next">3</div>
                <span class="step-label">Publish</span>
                <div class="step-caption">Finalize</div>
            </div>
        </div>

        {{errors_html}}

        <form action="/submit-exam" method="POST" class="row g-3">
            <input type="hidden" name="exam_id" value="{{exam_id}}">
            <div class="col-12">
                <label class="form-label">Exam Title</label>
                <input type="text" name="title" class="form-control" placeholder="e.g. Web Programming Midterm" required
                    value="{{title}}">
            </div>

            <div class="col-12">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="3"
                    placeholder="Briefly describe what this exam will cover." required>{{description}}</textarea>
            </div>

            <div class="col-md-4">
                <label class="form-label">Exam Date</label>
                <input type="date" name="exam_date" class="form-control" required value="{{exam_date}}">
            </div>

            <div class="col-md-4">
                <label class="form-label">Start Time</label>
                <input type="time" name="start_time" id="start_time" class="form-control" required
                    value="{{start_time}}">
                <small class="text-muted">24-hour format</small>
            </div>

            <div class="col-md-4">
                <label class="form-label">End Time</label>
                <input type="time" name="end_time" id="end_time" class="form-control" required value="{{end_time}}">
                <small class="text-muted">Auto-calculated</small>
            </div>

            <div class="col-md-4">
                <label class="form-label">Duration (minutes)</label>
                <input type="number" name="duration" id="duration" class="form-control" placeholder="e.g. 60" min="1"
                    required value="{{duration}}">
                <small class="text-muted">Auto-calculated</small>
            </div>

            <div class="col-12">
                <label class="form-label">Instructions for Students</label>
                <textarea name="instructions" class="form-control" rows="4"
                    placeholder="Example: Ensure a stable internet connection. Do not refresh the page."
                    required>{{instructions}}</textarea>
            </div>

            <div class="col-12 d-flex justify-content-end mt-2">
                <button type="submit" class="btn btn-primary btn-rounded">
                    Next
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    const startTimeInput = document.getElementById('start_time');
    const endTimeInput = document.getElementById('end_time');
    const durationInput = document.getElementById('duration');

    // Helper: Convert time string (HH:MM) to minutes from midnight
    function timeToMinutes(timeStr) {
        if (!timeStr) return null;
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }

    // Helper: Convert minutes from midnight to time string (HH:MM)
    function minutesToTime(minutes) {
        const hours = Math.floor(minutes / 60) % 24;
        const mins = minutes % 60;
        return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
    }

    // Calculate End Time from Start Time + Duration
    function calculateEndTime() {
        const startTime = startTimeInput.value;
        const duration = parseInt(durationInput.value);

        if (startTime && duration > 0) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = startMinutes + duration;
            endTimeInput.value = minutesToTime(endMinutes);
        }
    }

    // Calculate Duration from Start Time and End Time
    function calculateDuration() {
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (startTime && endTime) {
            const startMinutes = timeToMinutes(startTime);
            let endMinutes = timeToMinutes(endTime);

            // Handle cases where end time is on the next day
            if (endMinutes <= startMinutes) {
                endMinutes += 24 * 60; // Add 24 hours
            }

            const duration = endMinutes - startMinutes;
            if (duration > 0) {
                durationInput.value = duration;
            }
        }
    }

    // Event listeners
    startTimeInput.addEventListener('change', calculateEndTime);
    durationInput.addEventListener('input', calculateEndTime);
    endTimeInput.addEventListener('change', calculateDuration);

    // Initial calculation on page load if values exist
    if (startTimeInput.value && durationInput.value) {
        calculateEndTime();
    }
})();
</script>